#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const dataDir = path.join(root, 'src', 'data');
const libDir = path.join(root, 'src', 'lib');

const possiblePath = path.join(dataDir, 'possible_words.txt');
const allowedPath = path.join(dataDir, 'allowed_words.txt');
const answersByDatePath = path.join(dataDir, 'answers_by_date_wordlist.txt');
const overridesPath = path.join(dataDir, 'answer_overrides.txt');
const wordlistsTsPath = path.join(libDir, 'wordlists.ts');

const normalizeWord = (w) => w.trim().toLowerCase();
const isWord = (w) => /^[a-z]{5}$/.test(w);

function readLineWords(filePath) {
  return fs
    .readFileSync(filePath, 'utf8')
    .split(/\r?\n/)
    .map(normalizeWord)
    .filter(Boolean)
    .filter(isWord);
}

function readCommaOrLineWords(filePath) {
  return fs
    .readFileSync(filePath, 'utf8')
    .split(/[\r\n,]+/)
    .map(normalizeWord)
    .filter(Boolean)
    .filter(isWord);
}

const possible = readLineWords(possiblePath);
const allowed = readLineWords(allowedPath);
const answersByDate = readCommaOrLineWords(answersByDatePath);
const overrides = fs.existsSync(overridesPath)
  ? fs
      .readFileSync(overridesPath, 'utf8')
      .split(/\r?\n/)
      .map((x) => x.replace(/#.*/, '').trim().toLowerCase())
      .filter(Boolean)
      .filter(isWord)
  : [];

const possibleSet = new Set(possible);
const appendedFromAnswers = [];
for (const w of answersByDate) {
  if (!possibleSet.has(w)) {
    possibleSet.add(w);
    possible.push(w);
    appendedFromAnswers.push(w);
  }
}

const appendedFromOverrides = [];
for (const w of overrides) {
  if (!possibleSet.has(w)) {
    possibleSet.add(w);
    possible.push(w);
    appendedFromOverrides.push(w);
  }
}

const generatedAt = new Date().toISOString();

fs.writeFileSync(possiblePath, `${possible.join('\n')}\n`, 'utf8');

const wordlistsTs = `// Auto-generated by scripts/sync-wordlists.mjs\n// possible_words source: 3b1b/videos + answers_by_date merge\n// allowed_words source: 3b1b/videos\n\nexport const WORDLIST_META = {\n  generatedAt: ${JSON.stringify(generatedAt)},\n  possibleWordsCount: ${possible.length},\n  allowedWordsCount: ${allowed.length},\n  appendedFromAnswersByDateCount: ${appendedFromAnswers.length},
  appendedFromOverridesCount: ${appendedFromOverrides.length},\n} as const;\n\nexport const POSSIBLE_WORDS: string[] = ${JSON.stringify(possible)};\n\nexport const ALLOWED_WORDS: string[] = ${JSON.stringify(allowed)};\n`;

fs.writeFileSync(wordlistsTsPath, wordlistsTs, 'utf8');

console.log(
  `Synced wordlists. possible=${possible.length} allowed=${allowed.length} appendedFromAnswers=${appendedFromAnswers.length} appendedFromOverrides=${appendedFromOverrides.length}`,
);
if (appendedFromAnswers.length) {
  console.log(`Appended from answers_by_date: ${appendedFromAnswers.slice(0, 20).join(', ')}`);
}
if (appendedFromOverrides.length) {
  console.log(`Appended from overrides: ${appendedFromOverrides.slice(0, 20).join(', ')}`);
}
